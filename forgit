# 8) Training loop with early stopping

EPOCHS = 50
PATIENCE = 5

best_val_loss = float("inf")
best_state = None
epochs_no_improve = 0

print("\n=== Training neural network (PyTorch) ===")
for epoch in range(1, EPOCHS + 1):
    # train
    model.train()
    train_losses = []
    for xb, yb in train_loader:
        xb = xb.to(device)
        yb = yb.to(device)

        optimizer.zero_grad()
        preds = model(xb)
        loss = criterion(preds, yb)
        loss.backward()
        optimizer.step()
        train_losses.append(loss.item())

    # validation
    model.eval()
    val_losses = []
    with torch.no_grad():
        for xb, yb in val_loader:
            xb = xb.to(device)
            yb = yb.to(device)
            preds = model(xb)
            loss = criterion(preds, yb)
            val_losses.append(loss.item())

    avg_train = float(np.mean(train_losses))
    avg_val = float(np.mean(val_losses))
    print(f"Epoch {epoch:02d} | Train loss: {avg_train:.4f} | Val loss: {avg_val:.4f}")

    # Early stopping
    if avg_val < best_val_loss - 1e-4:
        best_val_loss = avg_val
        best_state = model.state_dict()
        epochs_no_improve = 0
    else:
        epochs_no_improve += 1
        if epochs_no_improve >= PATIENCE:
            print(f"Early stopping triggered at epoch {epoch}.")
            break

if best_state is not None:
    model.load_state_dict(best_state)
